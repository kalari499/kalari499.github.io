---
layout: post
title: Let's build a home server (part 4)
description: Part 4 of the series Garnet - building a home server&#58; Bravo
category: Garnet
---

### Bravo

I code often and I use GitHub often too.
And having a local git server seems very advantageous.
I can have my private repo for a lot of testing and do not have to push my code publicly on GitHub anymore.

So Bravo is going to be a git server, running Gitea.
Gitea is a lightweight git server written in Go, forked from Gogs.

The starting point here is a fresh Debian install cloning from Debian-base and after changing hostname to bravo.

#### Gitea

Debian does not have a binary package for Gitea in main repository.
Instead I have to download the binary.

Alternatively, I can always compile it from sources.
But it's just more annoying, more time-consuming and more prequisites.
So maybe some other days when I need to tweak the code.

First we need to install the prequisite.
```
apt-get install git
```
I mean git server should have git installed right ?

The Gitea server would be run as user git (not www-data), on port 443 with HTTPS support.
Create system account git with correct permission, this would also create a group git.
```
useradd -r -m -s /bin/bash git
```

Create some required directories.
```
mkdir -p /var/lib/gitea/{custom,data,log}
chown -R git:git /var/lib/gitea/
chmod -R 750 /var/lib/gitea/

mkdir /etc/gitea
chown root:git /etc/gitea
chmod 770 /etc/gitea
```

Download the binary.
```
wget -O /usr/bin/gitea https://dl.gitea.io/gitea/1.10.1/gitea-1.10.1-linux-amd64
chmod +x /usr/bin/gitea
```

Finally add a service file for systemd to manage.
```
cat << EOF > /etc/systemd/system/gitea.service
[Unit]
Description=Gitea (Git with a cup of tea)
After=syslog.target
After=network.target

[Service]
Type=simple
User=git
Group=git
WorkingDirectory=/var/lib/gitea/
ExecStart=/usr/bin/gitea web --config /etc/gitea/app.ini
Restart=always
Environment=USER=git HOME=/home/git GITEA_WORK_DIR=/var/lib/gitea
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE

[Install]
WantedBy=multi-user.target
EOF

systemctl enable --now gitea
```

#### HTTPS support

Gitea has built-in HTTPS support.
I just need to modify app.ini file.

First let's generate the SSL certificate
```
mkdir -p /etc/gitea/ssl-certs
cd /etc/gitea/ssl-certs

openssl genrsa -out bravo.key 2048
openssl req -new -key bravo.key -out bravo.csr
openssl x509 -req -days 365 -in bravo.csr -signkey bravo.key -out bravo.crt

chown -R root:git /etc/gitea/ssl-certs
chmod 640 bravo.key
```

Then add some config to app.ini.
```
cat << EOF >> /etc/gitea/app.ini

[server]
PROTOCOL = https
HTTP_PORT = 443
CERT_FILE = /etc/gitea/ssl-certs/bravo.crt
KEY_FILE = /etc/gitea/ssl-certs/bravo.key
EOF
```

**Note**: Additional I can make port 80 redirects to port 3000 with `REDIRECT_OTHER_PORT = true` and `PORT_TO_REDIRECT = 80`.
However it also requires `ROOT_URL` variable, or the server's URL, which I don't have yet because I haven't set up DNS server.
I will go back to this later, for now the git server only serves on port 443.

The git server hasn't been finished yet, there is still 1 last step.
Navigating to `/install` on the webpage to setup the initial installation, including databases and other settings.
But before doing that, I need an name for the machine and a DNS server.

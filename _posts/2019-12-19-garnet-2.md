---
layout: post
title: Let's build a home server (part 2)
description: Part 2 of the series Garnet - building a home server&#58; Alpha
category: Garnet
---

### Introduction

You know what they say, the first step is always the hardest one.
So let's start with something really really simple to test the water.

In fact I want the process of creating this VM would be the basic template for the following VMs.

### Alpha

I'm creating Alpha to be an Apache webserver running PHP.
Choice of OS here is Ubuntu Server 18.04 LTS, running headless.
In addition, I will add HTTPS support for the webserver with self-signed certificate for demonstration.

**Note**: Avoid using HTTP whenever possible, HTTP connection is in plain-text and can be sniffed.

#### Bare system

In VirtualBox, create a new VM with type Linux - Ubuntu (64-bit), with 512MB RAM and 10GB hard disk.
Most of the default settings are fine, except some small changes:
- Storage: Add Ubuntu live ISO file to Controller IDE section
- Network: Add 1 interface with bridged adapter through wlp2s0
- Optional: Turn off audio, change pointing device to PS/2 Mouse and turn off USB controller

Turn on the VM and install the Ubuntu Server.
Again, most settings can be kept default.
The administrative user is alpha@alpha.
Don't forget to choose a strong password because for now the webserver is exposed to the local subnet.

In addition, I choose to install a SSH server as well so I could manage the machine from my main laptop.
I choose not to install any snap programs in the next screen.

After finishing the installation, detach the live ISO and change the setting in System so the VM only boot from Hard Disk.

From this point I have created a bare template to build more stuffs on.

**Note**: Take snapshot often so you can revert anytime you want, or port it to other machine.

#### First step

All tasks from now can be performed through SSH, in addition to physical access to the console.
Furthermore, most commands here need administrative access so I use a root shell
```
sudo su
```

The first thing to do after a fresh installation is always
```
apt-get update && apt-get upgrade
```
to keep the system up-to-date.

#### Apache webserver

Install Apache
```
apt-get install apache2
```

For security reason, the webserver should be run as www-data instead of root.
This means even if the server is hacked, the attackers wouldn't have root permission.

By convention, the webserver is located in /var/www/ directory and Apache default webroot is /var/www/html/.
Change correct permission of the webroot.
```
chown -R www-data:www-data /var/www/
```
Now I can edit webserver's content as www-data.

#### PHP support

Install PHP and PHP support for Apache.
```
apt-get install php libapache2-mod-php
```

#### HTTPS support

I use self-signed certificate here for demonstration, instead of default snakeoil certificate.
```
mkdir -p /etc/apache2/ssl-certs
cd /etc/apache2/ssl-certs

openssl genrsa -out alpha.key 1024
openssl req -new -key alpha.key -out alpha.csr
openssl x509 -req -days 365 -in alpha.csr -signkey alpha.key -out alpha.crt
```

Add a new HTTPS site on port 443, using the previous certificate.
```
cat << EOF > /etc/apache2/sites-available/alpha-https.conf
<VirtualHost *:443>
        ServerAdmin webmaster@localhost

        DocumentRoot /var/www/html

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        SSLEngine on

        SSLCertificateFile      /etc/apache2/ssl-certs/alpha.crt
        SSLCertificateKeyFile   /etc/apache2/ssl-certs/alpha.key

        <FilesMatch "\.(cgi|shtml|phtml|php)$">
                        SSLOptions +StdEnvVars
        </FilesMatch>
        <Directory /usr/lib/cgi-bin>
                        SSLOptions +StdEnvVars
        </Directory>
</VirtualHost>
EOF

ln -s ../sites-available/alpha-https.conf /etc/apache2/sites-enabled/alpha-https.conf
```

Finally, enable SSL module and restart Apache.
```
a2enmod ssl
systemctl restart apache2
```

With just that, I have created a basic functional Apache webserver with PHP and HTTPS support.
There are no actual contents yet.
I will come back to the server later for more stuffs, such as PHP programming or virtualhost routing.
